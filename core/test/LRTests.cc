#include "doctest/doctest.h"

#include "machines/CFG.h"
#include "parser/lr.h"

class LRTest {
protected:
    LR lr{};

protected:
    LR::ItemSet closure(const LR::ItemSet& item, const std::string& separator, const CFG& cfg) {
        return LR::closure(item, separator, cfg);
    }

    void setup(const CFG& cfg) { this->lr = LR(cfg); }

    const LR::ParsingTable& get_table() const { return this->lr.table; }
};

TEST_SUITE("LRTests") {
    TEST_CASE_FIXTURE(LRTest, "[LRTests] closure") {
        const std::string separator("路");
        const LR::ItemSet start_item_set{{LR::Item{"S", {separator, "A", "A"}}}};

        const CFG cfg("./test/res/input/CFG2.json");

        CHECK_EQ(closure(start_item_set, separator, cfg),
                 LR::ItemSet{{{"A", {"路", "a", "A"}}, {"A", {"路", "b"}}, {"S", {"路", "A", "A"}}}});
    }

    TEST_CASE_FIXTURE(LRTest, "[LRTests] parsing_table") {
        const CFG cfg("./test/res/input/CFG2.json");
        setup(cfg);

        LR::ParsingTable table{
            {0, {{{"a", {LR::ActionType::Shift, 1}}, {"b", {LR::ActionType::Shift, 2}}}, {{"A", 3}, {"S", 4}}}},
            {1, {{{"a", {LR::ActionType::Shift, 1}}, {"b", {LR::ActionType::Shift, 2}}}, {{"A", 5}}}},
            {2,
             {{{"$", {LR::ActionType::Reduce, 1}},
               {"a", {LR::ActionType::Reduce, 1}},
               {"b", {LR::ActionType::Reduce, 1}}},
              {}}},
            {3, {{{"a", {LR::ActionType::Shift, 1}}, {"b", {LR::ActionType::Shift, 2}}}, {{"A", 6}}}},
            {4, {{{"$", {LR::ActionType::Accept, 0}}}, {}}},
            {5,
             {{{"$", {LR::ActionType::Reduce, 0}},
               {"a", {LR::ActionType::Reduce, 0}},
               {"b", {LR::ActionType::Reduce, 0}}},
              {}}},
            {6, {{{"$", {LR::ActionType::Reduce, 2}}}, {}}}};

        CHECK_EQ(table, get_table());
    }

    TEST_CASE_FIXTURE(LRTest, "[LRTests] table_edge_case_0") {
        const CFG cfg = CFG::parse_ebnf("test/res/input/EBNF0.txt");
        setup(cfg);

        const LR::ParsingTable table{
            {0, {{{"literal", {LR::ActionType::Shift, 3}}}, {{"<assignment>", 4}, {"<expression>", 1}, {"<term>", 2}}}},
            {1, {{{";", {LR::ActionType::Shift, 5}}}, {}}},
            {2, {{{"+", {LR::ActionType::Shift, 6}}, {";", {LR::ActionType::Reduce, 1}}}, {}}},
            {3,
             {{{"*", {LR::ActionType::Shift, 7}},
               {"+", {LR::ActionType::Reduce, 3}},
               {";", {LR::ActionType::Reduce, 3}}},
              {}}},
            {4, {{{"$", {LR::ActionType::Accept, 0}}}, {}}},
            {5, {{{"$", {LR::ActionType::Reduce, 0}}}, {}}},
            {6, {{{"literal", {LR::ActionType::Shift, 3}}}, {{"<expression>", 8}, {"<term>", 2}}}},
            {7, {{{"literal", {LR::ActionType::Shift, 3}}}, {{"<term>", 9}}}},
            {8, {{{";", {LR::ActionType::Reduce, 2}}}, {}}},
            {9, {{{"+", {LR::ActionType::Reduce, 4}}, {";", {LR::ActionType::Reduce, 4}}}, {}}}};

        CHECK_EQ(table, get_table());
    }

    TEST_CASE_FIXTURE(LRTest, "[LRTests] pai_parse_table") {
        const CFG cfg = CFG::parse_ebnf("test/res/input/EBNF2CFG.txt");
        setup(cfg);

        const LR::ParsingTable table{
            {0, {{{"fn", {LR::ActionType::Shift, 1}}}, {{"<function>", 2}, {"<program>", 3}}}},
            {1, {{{"identifier", {LR::ActionType::Shift, 4}}}, {}}},
            {2,
             {{{"$", {LR::ActionType::Reduce, 30}}, {"fn", {LR::ActionType::Shift, 1}}},
              {{"<function>", 2}, {"<program>", 5}}}},
            {3, {{{"$", {LR::ActionType::Accept, 0}}}, {}}},
            {4, {{{"(", {LR::ActionType::Shift, 6}}}, {}}},
            {5, {{{"$", {LR::ActionType::Reduce, 31}}}, {}}},
            {6,
             {{{")", {LR::ActionType::Shift, 8}}, {"identifier", {LR::ActionType::Shift, 7}}}, {{"<arguments>", 9}}}},
            {7, {{{")", {LR::ActionType::Reduce, 0}}, {",", {LR::ActionType::Shift, 10}}}, {}}},
            {8, {{{"{", {LR::ActionType::Shift, 11}}}, {}}},
            {9, {{{")", {LR::ActionType::Shift, 12}}}, {}}},
            {10, {{{"identifier", {LR::ActionType::Shift, 7}}}, {{"<arguments>", 13}}}},
            {11,
             {{{"identifier", {LR::ActionType::Shift, 14}},
               {"if", {LR::ActionType::Shift, 19}},
               {"let", {LR::ActionType::Shift, 15}},
               {"return", {LR::ActionType::Shift, 20}},
               {"while", {LR::ActionType::Shift, 26}},
               {"}", {LR::ActionType::Shift, 18}}},
              {{"<assignment>", 21},
               {"<body>", 17},
               {"<function_call>", 22},
               {"<if>", 23},
               {"<return>", 24},
               {"<statement>", 16},
               {"<while>", 25}}}},
            {12, {{{"{", {LR::ActionType::Shift, 27}}}, {}}},
            {13, {{{")", {LR::ActionType::Reduce, 1}}}, {}}},
            {14, {{{"(", {LR::ActionType::Shift, 29}}, {"=", {LR::ActionType::Shift, 28}}}, {}}},
            {15, {{{"identifier", {LR::ActionType::Shift, 30}}}, {}}},
            {16,
             {{{"identifier", {LR::ActionType::Shift, 14}},
               {"if", {LR::ActionType::Shift, 19}},
               {"let", {LR::ActionType::Shift, 15}},
               {"return", {LR::ActionType::Shift, 20}},
               {"while", {LR::ActionType::Shift, 26}},
               {"}", {LR::ActionType::Reduce, 4}}},
              {{"<assignment>", 21},
               {"<body>", 31},
               {"<function_call>", 22},
               {"<if>", 23},
               {"<return>", 24},
               {"<statement>", 16},
               {"<while>", 25}}}},
            {17, {{{"}", {LR::ActionType::Shift, 32}}}, {}}},
            {18, {{{"$", {LR::ActionType::Reduce, 24}}, {"fn", {LR::ActionType::Reduce, 24}}}, {}}},
            {19,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<expression>", 33}, {"<factor>", 41}, {"<function_call>", 38}, {"<term>", 34}}}},
            {20,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<expression>", 42}, {"<factor>", 41}, {"<function_call>", 38}, {"<term>", 34}}}},
            {21,
             {{{"identifier", {LR::ActionType::Reduce, 33}},
               {"if", {LR::ActionType::Reduce, 33}},
               {"let", {LR::ActionType::Reduce, 33}},
               {"return", {LR::ActionType::Reduce, 33}},
               {"while", {LR::ActionType::Reduce, 33}},
               {"}", {LR::ActionType::Reduce, 33}}},
              {}}},
            {22, {{{";", {LR::ActionType::Shift, 43}}}, {}}},
            {23,
             {{{"identifier", {LR::ActionType::Reduce, 35}},
               {"if", {LR::ActionType::Reduce, 35}},
               {"let", {LR::ActionType::Reduce, 35}},
               {"return", {LR::ActionType::Reduce, 35}},
               {"while", {LR::ActionType::Reduce, 35}},
               {"}", {LR::ActionType::Reduce, 35}}},
              {}}},
            {24,
             {{{"identifier", {LR::ActionType::Reduce, 36}},
               {"if", {LR::ActionType::Reduce, 36}},
               {"let", {LR::ActionType::Reduce, 36}},
               {"return", {LR::ActionType::Reduce, 36}},
               {"while", {LR::ActionType::Reduce, 36}},
               {"}", {LR::ActionType::Reduce, 36}}},
              {}}},
            {25,
             {{{"identifier", {LR::ActionType::Reduce, 37}},
               {"if", {LR::ActionType::Reduce, 37}},
               {"let", {LR::ActionType::Reduce, 37}},
               {"return", {LR::ActionType::Reduce, 37}},
               {"while", {LR::ActionType::Reduce, 37}},
               {"}", {LR::ActionType::Reduce, 37}}},
              {}}},
            {26,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<expression>", 44}, {"<factor>", 41}, {"<function_call>", 38}, {"<term>", 34}}}},
            {27,
             {{{"identifier", {LR::ActionType::Shift, 14}},
               {"if", {LR::ActionType::Shift, 19}},
               {"let", {LR::ActionType::Shift, 15}},
               {"return", {LR::ActionType::Shift, 20}},
               {"while", {LR::ActionType::Shift, 26}}},
              {{"<assignment>", 21},
               {"<body>", 45},
               {"<function_call>", 22},
               {"<if>", 23},
               {"<return>", 24},
               {"<statement>", 16},
               {"<while>", 25}}}},
            {28,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<expression>", 46}, {"<factor>", 41}, {"<function_call>", 38}, {"<term>", 34}}}},
            {29,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {")", {LR::ActionType::Shift, 48}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<call_arguments>", 49},
               {"<expression>", 47},
               {"<factor>", 41},
               {"<function_call>", 38},
               {"<term>", 34}}}},
            {30, {{{"=", {LR::ActionType::Shift, 50}}}, {}}},
            {31, {{{"}", {LR::ActionType::Reduce, 5}}}, {}}},
            {32, {{{"$", {LR::ActionType::Reduce, 23}}, {"fn", {LR::ActionType::Reduce, 23}}}, {}}},
            {33,
             {{{"!", {LR::ActionType::Shift, 51}},
               {"+", {LR::ActionType::Shift, 52}},
               {"-", {LR::ActionType::Shift, 53}},
               {"<", {LR::ActionType::Shift, 54}},
               {"=", {LR::ActionType::Shift, 55}},
               {">", {LR::ActionType::Shift, 56}},
               {"{", {LR::ActionType::Shift, 57}}},
              {}}},
            {34,
             {{{"!", {LR::ActionType::Reduce, 16}},
               {")", {LR::ActionType::Reduce, 16}},
               {"*", {LR::ActionType::Shift, 58}},
               {"+", {LR::ActionType::Reduce, 16}},
               {",", {LR::ActionType::Reduce, 16}},
               {"-", {LR::ActionType::Reduce, 16}},
               {"/", {LR::ActionType::Shift, 59}},
               {";", {LR::ActionType::Reduce, 16}},
               {"<", {LR::ActionType::Reduce, 16}},
               {"=", {LR::ActionType::Reduce, 16}},
               {">", {LR::ActionType::Reduce, 16}},
               {"{", {LR::ActionType::Reduce, 16}}},
              {}}},
            {35, {{{"(", {LR::ActionType::Shift, 60}}}, {}}},
            {36,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<expression>", 61}, {"<factor>", 41}, {"<function_call>", 38}, {"<term>", 34}}}},
            {37,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 62}, {"<function_call>", 38}}}},
            {38,
             {{{"!", {LR::ActionType::Reduce, 20}},
               {")", {LR::ActionType::Reduce, 20}},
               {"*", {LR::ActionType::Reduce, 20}},
               {"+", {LR::ActionType::Reduce, 20}},
               {",", {LR::ActionType::Reduce, 20}},
               {"-", {LR::ActionType::Reduce, 20}},
               {"/", {LR::ActionType::Reduce, 20}},
               {";", {LR::ActionType::Reduce, 20}},
               {"<", {LR::ActionType::Reduce, 20}},
               {"=", {LR::ActionType::Reduce, 20}},
               {">", {LR::ActionType::Reduce, 20}},
               {"{", {LR::ActionType::Reduce, 20}}},
              {}}},
            {39,
             {{{"!", {LR::ActionType::Reduce, 21}},
               {"(", {LR::ActionType::Shift, 29}},
               {")", {LR::ActionType::Reduce, 21}},
               {"*", {LR::ActionType::Reduce, 21}},
               {"+", {LR::ActionType::Reduce, 21}},
               {",", {LR::ActionType::Reduce, 21}},
               {"-", {LR::ActionType::Reduce, 21}},
               {"/", {LR::ActionType::Reduce, 21}},
               {";", {LR::ActionType::Reduce, 21}},
               {"<", {LR::ActionType::Reduce, 21}},
               {"=", {LR::ActionType::Reduce, 21}},
               {">", {LR::ActionType::Reduce, 21}},
               {"{", {LR::ActionType::Reduce, 21}}},
              {}}},
            {40,
             {{{"!", {LR::ActionType::Reduce, 22}},
               {")", {LR::ActionType::Reduce, 22}},
               {"*", {LR::ActionType::Reduce, 22}},
               {"+", {LR::ActionType::Reduce, 22}},
               {",", {LR::ActionType::Reduce, 22}},
               {"-", {LR::ActionType::Reduce, 22}},
               {"/", {LR::ActionType::Reduce, 22}},
               {";", {LR::ActionType::Reduce, 22}},
               {"<", {LR::ActionType::Reduce, 22}},
               {"=", {LR::ActionType::Reduce, 22}},
               {">", {LR::ActionType::Reduce, 22}},
               {"{", {LR::ActionType::Reduce, 22}}},
              {}}},
            {41,
             {{{"!", {LR::ActionType::Reduce, 38}},
               {")", {LR::ActionType::Reduce, 38}},
               {"*", {LR::ActionType::Reduce, 38}},
               {"+", {LR::ActionType::Reduce, 38}},
               {",", {LR::ActionType::Reduce, 38}},
               {"-", {LR::ActionType::Reduce, 38}},
               {"/", {LR::ActionType::Reduce, 38}},
               {";", {LR::ActionType::Reduce, 38}},
               {"<", {LR::ActionType::Reduce, 38}},
               {"=", {LR::ActionType::Reduce, 38}},
               {">", {LR::ActionType::Reduce, 38}},
               {"{", {LR::ActionType::Reduce, 38}}},
              {}}},
            {42,
             {{{"!", {LR::ActionType::Shift, 51}},
               {"+", {LR::ActionType::Shift, 52}},
               {"-", {LR::ActionType::Shift, 53}},
               {";", {LR::ActionType::Shift, 63}},
               {"<", {LR::ActionType::Shift, 54}},
               {"=", {LR::ActionType::Shift, 55}},
               {">", {LR::ActionType::Shift, 56}}},
              {}}},
            {43,
             {{{"identifier", {LR::ActionType::Reduce, 34}},
               {"if", {LR::ActionType::Reduce, 34}},
               {"let", {LR::ActionType::Reduce, 34}},
               {"return", {LR::ActionType::Reduce, 34}},
               {"while", {LR::ActionType::Reduce, 34}},
               {"}", {LR::ActionType::Reduce, 34}}},
              {}}},
            {44,
             {{{"!", {LR::ActionType::Shift, 51}},
               {"+", {LR::ActionType::Shift, 52}},
               {"-", {LR::ActionType::Shift, 53}},
               {"<", {LR::ActionType::Shift, 54}},
               {"=", {LR::ActionType::Shift, 55}},
               {">", {LR::ActionType::Shift, 56}},
               {"{", {LR::ActionType::Shift, 64}}},
              {}}},
            {45, {{{"}", {LR::ActionType::Shift, 65}}}, {}}},
            {46,
             {{{"!", {LR::ActionType::Shift, 51}},
               {"+", {LR::ActionType::Shift, 52}},
               {"-", {LR::ActionType::Shift, 53}},
               {";", {LR::ActionType::Shift, 66}},
               {"<", {LR::ActionType::Shift, 54}},
               {"=", {LR::ActionType::Shift, 55}},
               {">", {LR::ActionType::Shift, 56}}},
              {}}},
            {47,
             {{{"!", {LR::ActionType::Shift, 51}},
               {")", {LR::ActionType::Reduce, 6}},
               {"+", {LR::ActionType::Shift, 52}},
               {",", {LR::ActionType::Shift, 67}},
               {"-", {LR::ActionType::Shift, 53}},
               {"<", {LR::ActionType::Shift, 54}},
               {"=", {LR::ActionType::Shift, 55}},
               {">", {LR::ActionType::Shift, 56}}},
              {}}},
            {48,
             {{{"!", {LR::ActionType::Reduce, 26}},
               {")", {LR::ActionType::Reduce, 26}},
               {"*", {LR::ActionType::Reduce, 26}},
               {"+", {LR::ActionType::Reduce, 26}},
               {",", {LR::ActionType::Reduce, 26}},
               {"-", {LR::ActionType::Reduce, 26}},
               {"/", {LR::ActionType::Reduce, 26}},
               {";", {LR::ActionType::Reduce, 26}},
               {"<", {LR::ActionType::Reduce, 26}},
               {"=", {LR::ActionType::Reduce, 26}},
               {">", {LR::ActionType::Reduce, 26}},
               {"{", {LR::ActionType::Reduce, 26}}},
              {}}},
            {49, {{{")", {LR::ActionType::Shift, 68}}}, {}}},
            {50,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<expression>", 69}, {"<factor>", 41}, {"<function_call>", 38}, {"<term>", 34}}}},
            {51, {{{"=", {LR::ActionType::Shift, 70}}}, {}}},
            {52,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 41}, {"<function_call>", 38}, {"<term>", 71}}}},
            {53,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 41}, {"<function_call>", 38}, {"<term>", 72}}}},
            {54,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"=", {LR::ActionType::Shift, 74}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 41}, {"<function_call>", 38}, {"<term>", 73}}}},
            {55, {{{"=", {LR::ActionType::Shift, 75}}}, {}}},
            {56,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"=", {LR::ActionType::Shift, 77}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 41}, {"<function_call>", 38}, {"<term>", 76}}}},
            {57,
             {{{"identifier", {LR::ActionType::Shift, 14}},
               {"if", {LR::ActionType::Shift, 19}},
               {"let", {LR::ActionType::Shift, 15}},
               {"return", {LR::ActionType::Shift, 20}},
               {"while", {LR::ActionType::Shift, 26}}},
              {{"<assignment>", 21},
               {"<body>", 78},
               {"<function_call>", 22},
               {"<if>", 23},
               {"<return>", 24},
               {"<statement>", 16},
               {"<while>", 25}}}},
            {58,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 79}, {"<function_call>", 38}}}},
            {59,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 80}, {"<function_call>", 38}}}},
            {60,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<expression>", 81}, {"<factor>", 41}, {"<function_call>", 38}, {"<term>", 34}}}},
            {61,
             {{{"!", {LR::ActionType::Shift, 51}},
               {")", {LR::ActionType::Shift, 82}},
               {"+", {LR::ActionType::Shift, 52}},
               {"-", {LR::ActionType::Shift, 53}},
               {"<", {LR::ActionType::Shift, 54}},
               {"=", {LR::ActionType::Shift, 55}},
               {">", {LR::ActionType::Shift, 56}}},
              {}}},
            {62,
             {{{"!", {LR::ActionType::Reduce, 19}},
               {")", {LR::ActionType::Reduce, 19}},
               {"*", {LR::ActionType::Reduce, 19}},
               {"+", {LR::ActionType::Reduce, 19}},
               {",", {LR::ActionType::Reduce, 19}},
               {"-", {LR::ActionType::Reduce, 19}},
               {"/", {LR::ActionType::Reduce, 19}},
               {";", {LR::ActionType::Reduce, 19}},
               {"<", {LR::ActionType::Reduce, 19}},
               {"=", {LR::ActionType::Reduce, 19}},
               {">", {LR::ActionType::Reduce, 19}},
               {"{", {LR::ActionType::Reduce, 19}}},
              {}}},
            {63,
             {{{"identifier", {LR::ActionType::Reduce, 32}},
               {"if", {LR::ActionType::Reduce, 32}},
               {"let", {LR::ActionType::Reduce, 32}},
               {"return", {LR::ActionType::Reduce, 32}},
               {"while", {LR::ActionType::Reduce, 32}},
               {"}", {LR::ActionType::Reduce, 32}}},
              {}}},
            {64,
             {{{"identifier", {LR::ActionType::Shift, 14}},
               {"if", {LR::ActionType::Shift, 19}},
               {"let", {LR::ActionType::Shift, 15}},
               {"return", {LR::ActionType::Shift, 20}},
               {"while", {LR::ActionType::Shift, 26}}},
              {{"<assignment>", 21},
               {"<body>", 83},
               {"<function_call>", 22},
               {"<if>", 23},
               {"<return>", 24},
               {"<statement>", 16},
               {"<while>", 25}}}},
            {65, {{{"$", {LR::ActionType::Reduce, 25}}, {"fn", {LR::ActionType::Reduce, 25}}}, {}}},
            {66,
             {{{"identifier", {LR::ActionType::Reduce, 2}},
               {"if", {LR::ActionType::Reduce, 2}},
               {"let", {LR::ActionType::Reduce, 2}},
               {"return", {LR::ActionType::Reduce, 2}},
               {"while", {LR::ActionType::Reduce, 2}},
               {"}", {LR::ActionType::Reduce, 2}}},
              {}}},
            {67,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<call_arguments>", 84},
               {"<expression>", 47},
               {"<factor>", 41},
               {"<function_call>", 38},
               {"<term>", 34}}}},
            {68,
             {{{"!", {LR::ActionType::Reduce, 27}},
               {")", {LR::ActionType::Reduce, 27}},
               {"*", {LR::ActionType::Reduce, 27}},
               {"+", {LR::ActionType::Reduce, 27}},
               {",", {LR::ActionType::Reduce, 27}},
               {"-", {LR::ActionType::Reduce, 27}},
               {"/", {LR::ActionType::Reduce, 27}},
               {";", {LR::ActionType::Reduce, 27}},
               {"<", {LR::ActionType::Reduce, 27}},
               {"=", {LR::ActionType::Reduce, 27}},
               {">", {LR::ActionType::Reduce, 27}},
               {"{", {LR::ActionType::Reduce, 27}}},
              {}}},
            {69,
             {{{"!", {LR::ActionType::Shift, 51}},
               {"+", {LR::ActionType::Shift, 52}},
               {"-", {LR::ActionType::Shift, 53}},
               {";", {LR::ActionType::Shift, 85}},
               {"<", {LR::ActionType::Shift, 54}},
               {"=", {LR::ActionType::Shift, 55}},
               {">", {LR::ActionType::Shift, 56}}},
              {}}},
            {70,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 41}, {"<function_call>", 38}, {"<term>", 86}}}},
            {71,
             {{{"!", {LR::ActionType::Reduce, 9}},
               {")", {LR::ActionType::Reduce, 9}},
               {"*", {LR::ActionType::Shift, 58}},
               {"+", {LR::ActionType::Reduce, 9}},
               {",", {LR::ActionType::Reduce, 9}},
               {"-", {LR::ActionType::Reduce, 9}},
               {"/", {LR::ActionType::Shift, 59}},
               {";", {LR::ActionType::Reduce, 9}},
               {"<", {LR::ActionType::Reduce, 9}},
               {"=", {LR::ActionType::Reduce, 9}},
               {">", {LR::ActionType::Reduce, 9}},
               {"{", {LR::ActionType::Reduce, 9}}},
              {}}},
            {72,
             {{{"!", {LR::ActionType::Reduce, 10}},
               {")", {LR::ActionType::Reduce, 10}},
               {"*", {LR::ActionType::Shift, 58}},
               {"+", {LR::ActionType::Reduce, 10}},
               {",", {LR::ActionType::Reduce, 10}},
               {"-", {LR::ActionType::Reduce, 10}},
               {"/", {LR::ActionType::Shift, 59}},
               {";", {LR::ActionType::Reduce, 10}},
               {"<", {LR::ActionType::Reduce, 10}},
               {"=", {LR::ActionType::Reduce, 10}},
               {">", {LR::ActionType::Reduce, 10}},
               {"{", {LR::ActionType::Reduce, 10}}},
              {}}},
            {73,
             {{{"!", {LR::ActionType::Reduce, 11}},
               {")", {LR::ActionType::Reduce, 11}},
               {"*", {LR::ActionType::Shift, 58}},
               {"+", {LR::ActionType::Reduce, 11}},
               {",", {LR::ActionType::Reduce, 11}},
               {"-", {LR::ActionType::Reduce, 11}},
               {"/", {LR::ActionType::Shift, 59}},
               {";", {LR::ActionType::Reduce, 11}},
               {"<", {LR::ActionType::Reduce, 11}},
               {"=", {LR::ActionType::Reduce, 11}},
               {">", {LR::ActionType::Reduce, 11}},
               {"{", {LR::ActionType::Reduce, 11}}},
              {}}},
            {74,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 41}, {"<function_call>", 38}, {"<term>", 87}}}},
            {75,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 41}, {"<function_call>", 38}, {"<term>", 88}}}},
            {76,
             {{{"!", {LR::ActionType::Reduce, 14}},
               {")", {LR::ActionType::Reduce, 14}},
               {"*", {LR::ActionType::Shift, 58}},
               {"+", {LR::ActionType::Reduce, 14}},
               {",", {LR::ActionType::Reduce, 14}},
               {"-", {LR::ActionType::Reduce, 14}},
               {"/", {LR::ActionType::Shift, 59}},
               {";", {LR::ActionType::Reduce, 14}},
               {"<", {LR::ActionType::Reduce, 14}},
               {"=", {LR::ActionType::Reduce, 14}},
               {">", {LR::ActionType::Reduce, 14}},
               {"{", {LR::ActionType::Reduce, 14}}},
              {}}},
            {77,
             {{{"!", {LR::ActionType::Shift, 35}},
               {"(", {LR::ActionType::Shift, 36}},
               {"-", {LR::ActionType::Shift, 37}},
               {"identifier", {LR::ActionType::Shift, 39}},
               {"literal", {LR::ActionType::Shift, 40}}},
              {{"<factor>", 41}, {"<function_call>", 38}, {"<term>", 89}}}},
            {78, {{{"}", {LR::ActionType::Shift, 90}}}, {}}},
            {79,
             {{{"!", {LR::ActionType::Reduce, 39}},
               {")", {LR::ActionType::Reduce, 39}},
               {"*", {LR::ActionType::Reduce, 39}},
               {"+", {LR::ActionType::Reduce, 39}},
               {",", {LR::ActionType::Reduce, 39}},
               {"-", {LR::ActionType::Reduce, 39}},
               {"/", {LR::ActionType::Reduce, 39}},
               {";", {LR::ActionType::Reduce, 39}},
               {"<", {LR::ActionType::Reduce, 39}},
               {"=", {LR::ActionType::Reduce, 39}},
               {">", {LR::ActionType::Reduce, 39}},
               {"{", {LR::ActionType::Reduce, 39}}},
              {}}},
            {80,
             {{{"!", {LR::ActionType::Reduce, 40}},
               {")", {LR::ActionType::Reduce, 40}},
               {"*", {LR::ActionType::Reduce, 40}},
               {"+", {LR::ActionType::Reduce, 40}},
               {",", {LR::ActionType::Reduce, 40}},
               {"-", {LR::ActionType::Reduce, 40}},
               {"/", {LR::ActionType::Reduce, 40}},
               {";", {LR::ActionType::Reduce, 40}},
               {"<", {LR::ActionType::Reduce, 40}},
               {"=", {LR::ActionType::Reduce, 40}},
               {">", {LR::ActionType::Reduce, 40}},
               {"{", {LR::ActionType::Reduce, 40}}},
              {}}},
            {81,
             {{{"!", {LR::ActionType::Shift, 51}},
               {")", {LR::ActionType::Shift, 91}},
               {"+", {LR::ActionType::Shift, 52}},
               {"-", {LR::ActionType::Shift, 53}},
               {"<", {LR::ActionType::Shift, 54}},
               {"=", {LR::ActionType::Shift, 55}},
               {">", {LR::ActionType::Shift, 56}}},
              {}}},
            {82,
             {{{"!", {LR::ActionType::Reduce, 18}},
               {")", {LR::ActionType::Reduce, 18}},
               {"*", {LR::ActionType::Reduce, 18}},
               {"+", {LR::ActionType::Reduce, 18}},
               {",", {LR::ActionType::Reduce, 18}},
               {"-", {LR::ActionType::Reduce, 18}},
               {"/", {LR::ActionType::Reduce, 18}},
               {";", {LR::ActionType::Reduce, 18}},
               {"<", {LR::ActionType::Reduce, 18}},
               {"=", {LR::ActionType::Reduce, 18}},
               {">", {LR::ActionType::Reduce, 18}},
               {"{", {LR::ActionType::Reduce, 18}}},
              {}}},
            {83, {{{"}", {LR::ActionType::Shift, 92}}}, {}}},
            {84, {{{")", {LR::ActionType::Reduce, 7}}}, {}}},
            {85,
             {{{"identifier", {LR::ActionType::Reduce, 3}},
               {"if", {LR::ActionType::Reduce, 3}},
               {"let", {LR::ActionType::Reduce, 3}},
               {"return", {LR::ActionType::Reduce, 3}},
               {"while", {LR::ActionType::Reduce, 3}},
               {"}", {LR::ActionType::Reduce, 3}}},
              {}}},
            {86,
             {{{"!", {LR::ActionType::Reduce, 8}},
               {")", {LR::ActionType::Reduce, 8}},
               {"*", {LR::ActionType::Shift, 58}},
               {"+", {LR::ActionType::Reduce, 8}},
               {",", {LR::ActionType::Reduce, 8}},
               {"-", {LR::ActionType::Reduce, 8}},
               {"/", {LR::ActionType::Shift, 59}},
               {";", {LR::ActionType::Reduce, 8}},
               {"<", {LR::ActionType::Reduce, 8}},
               {"=", {LR::ActionType::Reduce, 8}},
               {">", {LR::ActionType::Reduce, 8}},
               {"{", {LR::ActionType::Reduce, 8}}},
              {}}},
            {87,
             {{{"!", {LR::ActionType::Reduce, 12}},
               {")", {LR::ActionType::Reduce, 12}},
               {"*", {LR::ActionType::Shift, 58}},
               {"+", {LR::ActionType::Reduce, 12}},
               {",", {LR::ActionType::Reduce, 12}},
               {"-", {LR::ActionType::Reduce, 12}},
               {"/", {LR::ActionType::Shift, 59}},
               {";", {LR::ActionType::Reduce, 12}},
               {"<", {LR::ActionType::Reduce, 12}},
               {"=", {LR::ActionType::Reduce, 12}},
               {">", {LR::ActionType::Reduce, 12}},
               {"{", {LR::ActionType::Reduce, 12}}},
              {}}},
            {88,
             {{{"!", {LR::ActionType::Reduce, 13}},
               {")", {LR::ActionType::Reduce, 13}},
               {"*", {LR::ActionType::Shift, 58}},
               {"+", {LR::ActionType::Reduce, 13}},
               {",", {LR::ActionType::Reduce, 13}},
               {"-", {LR::ActionType::Reduce, 13}},
               {"/", {LR::ActionType::Shift, 59}},
               {";", {LR::ActionType::Reduce, 13}},
               {"<", {LR::ActionType::Reduce, 13}},
               {"=", {LR::ActionType::Reduce, 13}},
               {">", {LR::ActionType::Reduce, 13}},
               {"{", {LR::ActionType::Reduce, 13}}},
              {}}},
            {89,
             {{{"!", {LR::ActionType::Reduce, 15}},
               {")", {LR::ActionType::Reduce, 15}},
               {"*", {LR::ActionType::Shift, 58}},
               {"+", {LR::ActionType::Reduce, 15}},
               {",", {LR::ActionType::Reduce, 15}},
               {"-", {LR::ActionType::Reduce, 15}},
               {"/", {LR::ActionType::Shift, 59}},
               {";", {LR::ActionType::Reduce, 15}},
               {"<", {LR::ActionType::Reduce, 15}},
               {"=", {LR::ActionType::Reduce, 15}},
               {">", {LR::ActionType::Reduce, 15}},
               {"{", {LR::ActionType::Reduce, 15}}},
              {}}},
            {90,
             {{{"else", {LR::ActionType::Shift, 93}},
               {"identifier", {LR::ActionType::Reduce, 28}},
               {"if", {LR::ActionType::Reduce, 28}},
               {"let", {LR::ActionType::Reduce, 28}},
               {"return", {LR::ActionType::Reduce, 28}},
               {"while", {LR::ActionType::Reduce, 28}},
               {"}", {LR::ActionType::Reduce, 28}}},
              {}}},
            {91,
             {{{"!", {LR::ActionType::Reduce, 17}},
               {")", {LR::ActionType::Reduce, 17}},
               {"*", {LR::ActionType::Reduce, 17}},
               {"+", {LR::ActionType::Reduce, 17}},
               {",", {LR::ActionType::Reduce, 17}},
               {"-", {LR::ActionType::Reduce, 17}},
               {"/", {LR::ActionType::Reduce, 17}},
               {";", {LR::ActionType::Reduce, 17}},
               {"<", {LR::ActionType::Reduce, 17}},
               {"=", {LR::ActionType::Reduce, 17}},
               {">", {LR::ActionType::Reduce, 17}},
               {"{", {LR::ActionType::Reduce, 17}}},
              {}}},
            {92,
             {{{"identifier", {LR::ActionType::Reduce, 41}},
               {"if", {LR::ActionType::Reduce, 41}},
               {"let", {LR::ActionType::Reduce, 41}},
               {"return", {LR::ActionType::Reduce, 41}},
               {"while", {LR::ActionType::Reduce, 41}},
               {"}", {LR::ActionType::Reduce, 41}}},
              {}}},
            {93, {{{"{", {LR::ActionType::Shift, 94}}}, {}}},
            {94,
             {{{"identifier", {LR::ActionType::Shift, 14}},
               {"if", {LR::ActionType::Shift, 19}},
               {"let", {LR::ActionType::Shift, 15}},
               {"return", {LR::ActionType::Shift, 20}},
               {"while", {LR::ActionType::Shift, 26}}},
              {{"<assignment>", 21},
               {"<body>", 95},
               {"<function_call>", 22},
               {"<if>", 23},
               {"<return>", 24},
               {"<statement>", 16},
               {"<while>", 25}}}},
            {95, {{{"}", {LR::ActionType::Shift, 96}}}, {}}},
            {96,
             {{{"identifier", {LR::ActionType::Reduce, 29}},
               {"if", {LR::ActionType::Reduce, 29}},
               {"let", {LR::ActionType::Reduce, 29}},
               {"return", {LR::ActionType::Reduce, 29}},
               {"while", {LR::ActionType::Reduce, 29}},
               {"}", {LR::ActionType::Reduce, 29}}},
              {}}}};

        CHECK_EQ(table, get_table());
    }

    TEST_CASE("[LRTests] factorial_parsing") {
        const CFG cfg = CFG::parse_ebnf("test/res/input/EBNF2CFG.txt");
        LR lr(cfg);

        const auto parse_result = lr.parse(StreamReader("test/res/input/factorial.cmm"));

        std::ifstream expected_file("test/res/expected/LRTests-factorial_parsing.txt");
        std::stringstream expected{};
        expected << expected_file.rdbuf();
        expected_file.close();

        // std::ofstream reset("test/res/expected/LRTests-factorial_parsing.txt");
        // reset << parse_result.second->getContent();
        // reset.close();

        CHECK(parse_result.success);
        CHECK(parse_result.tree.has_value());
        CHECK_EQ(expected.str(), parse_result.tree.value()->getContent());
    }

    TEST_CASE("[LRTests] error1") {
        const CFG cfg = CFG::parse_ebnf("res/grammar/paithon.gram");
        LR lr(cfg);

        const auto parse_result = lr.parse(StreamReader("test/res/input/Error1.cmm"));

        CHECK(!parse_result.success);
        CHECK(parse_result.tree.has_value());
        CHECK(parse_result.errors.size() == 1);

        if (!parse_result.errors.empty()) {
            std::string errorMessage = parse_result.errors[0].message;
            CHECK_EQ(errorMessage, "unexpected token found: `ain`");
        }
    }
    TEST_CASE("[LRTests] error2") {
        const CFG cfg = CFG::parse_ebnf("res/grammar/paithon.gram");
        LR lr(cfg);

        const auto parse_result = lr.parse(StreamReader("test/res/input/Error2.cmm"));

        CHECK(!parse_result.success);
        CHECK(parse_result.tree.has_value());
        CHECK(parse_result.errors.size() == 1);

        if (!parse_result.errors.empty()) {
            std::string errorMessage = parse_result.errors[0].message;
            CHECK_EQ(errorMessage, "unexpected token found: `5`");
        }
    }
    TEST_CASE("[LRTests] error3") {
        const CFG cfg = CFG::parse_ebnf("res/grammar/paithon.gram");
        LR lr(cfg);

        const auto parse_result = lr.parse(StreamReader("test/res/input/Error3.cmm"));

        CHECK(!parse_result.success);
        CHECK(parse_result.tree.has_value());
        CHECK(parse_result.errors.size() == 4);

        if (parse_result.errors.size() == 4) {
            CHECK_EQ(parse_result.errors[0].message, "unexpected token found: `{`");
            CHECK_EQ(parse_result.errors[1].message, "unexpected token found: `x`");
            CHECK_EQ(parse_result.errors[2].message, "unexpected token found: `}`");
            CHECK_EQ(parse_result.errors[3].message, "unexpected token found: `;`");
        }
    }

    TEST_CASE("[LRTests] error4") {
        const CFG cfg = CFG::parse_ebnf("res/grammar/paithon.gram");
        LR lr(cfg);

        const auto parse_result = lr.parse(StreamReader("test/res/input/Error4.cmm"));

        CHECK(!parse_result.success);
        CHECK(parse_result.tree.has_value());
        CHECK(parse_result.errors.size() == 4);

        if (parse_result.errors.size() == 4) {
            CHECK_EQ(parse_result.errors[0].message, "unexpected token found: `,`");
            CHECK_EQ(parse_result.errors[1].message, "unexpected token found: `,`");
            CHECK_EQ(parse_result.errors[2].message, "unexpected token found: `,`");
            CHECK_EQ(parse_result.errors[3].message, "unexpected token found: `=`");
        }
    }
}
